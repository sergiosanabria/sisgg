{% extends "::base.html.twig" %}
{%block title%}Detalles y acciones de empleado{%endblock%}
{%block ruta%}
<li>
    <a href="{{path('index')}}">Inicio</a> <span class="divider">/</span>
</li>
<li>
    <a href="{{path('empleados')}}">Empleados</a> <span class="divider">/</span>
</li>
<li>
    <a href="#">Detalles y acciones del empleado </a>
</li>
{%endblock%}
{% block content %}
<div class="row-fluid sortable">
    <div class="box span12">
        <div class="box-content">
<form class="form-horizontal">
    <legend>Detalles y acciones del empleado {{empleado.apellido}}, {{empleado.nombre}}</legend>
                    {% if error %}
                    <div class="alert alert-error">
                        <button type='button' class='close' data-dismiss='alert'>×</button>
                        <strong>{{ error }}</strong> 
                    </div>  
                    {% endif %}
    <ul class="nav nav-pills">
                <li class="active"><a href="{{path('empleados')}}"><i class="fa-icon-arrow-left"></i>Volver a lista de empleados</a></li>
            </ul>
    <div class="row-fluid sortable ui-sortable">	
        <div class="box span12">
                <div class="box-header">
                        <h2><i class="fa-icon-cogs"></i><span class="break"></span>Acciones</h2>
                </div>
                <div class="box-content">
                    
                    {%if empleado.primerPago ==null or ((empleado.cuenta.movimientos | length) > 0) %}      
                    {%if app.user.role.obtenerPermiso('empleado_Gestión_y_acciones_de_pago')%}
                    <a title="Ver pagos pendientes" onclick="pendientes('{{empleado.id}}');" href="#" {#href="{{path('pendientes', {'id':empleado.id})}}"#} class="quick-button-small span2">
                                <i class="fa-icon-asterisk"></i>
                                <p>Pagos pendientes</p>
                       {%if empleado.cantiadDePendientes == 0 %}
                                <span id="notiCantidadPendientes" class="notification blue">{{empleado.cantiadDePendientes}}</span>
                                {%else%}
                                <span id="notiCantidadPendientes" class="notification yellow">{{empleado.cantiadDePendientes}}</span>
                        {%endif%}
                        </a>
                     <div class="divider-vertical"></div>
                        <a href="#" onclick="nuevoContado('{{empleado.id}}');" title="Registrar retiro de haber en efectivo." class="quick-button-small span2">
                                <i class="fa-icon-money"></i>
                                <p>Retiro en efectivo</p>
                        </a>
                        <a href="#" onclick="nuevoAdicional('{{empleado.id}}');" title="Registrar un pago adicional al empleado que implica la suma de sus haberes." class="quick-button-small span2">
                                <i class="fa-icon-plus-sign"></i>
                                <p>Pago Adicional</p>
                        </a>
                      <a href="#" onclick="nuevoCancelar('{{empleado.id}}');" title="Registrar la cancelación de pagos, por sanciones, errores en emisiones u otros motivos. Implica un aumento en el debe, pero no implica movimiento de pago." class="quick-button-small span2">
                                <i class="fa-icon-minus-sign"></i>
                                <p>Cancelar pago</p>
                        </a>
                     <a href="#" onclick="nuevoEspecies('{{empleado.id}}');" title="Registrar el pago a un empleado por medio de especies (Productos que tenga a la venta)." class="quick-button-small span2">
                                <i class="fa-icon-barcode"></i>
                                <p>Pago en especies</p>
                        </a>
                     {%endif%}
                     {%if app.user.role.obtenerPermiso('empleado-Imprimir_detalles-Acciones_de_pago')%}
                     <a href="#" onclick="modalImprimir();"  class="quick-button-small span2">
                                <i class="fa-icon-print"></i>
                                <p>Imprimir</p>
                        </a>
                     {%endif%}
                      {#<a href="#" onclick="history.back();"  class="quick-button-small span2">
                                <i class="fa-icon-external-link"></i>
                                <p>Volver</p>
                        </a>#}
                     
                        {% endif %}
                   
                        <div class="clearfix"></div>
                </div>	
        </div><!--/span-->

</div>
<div class="row-fluid sortable ui-sortable">
    <div class="box span12">
        <div class="box-header">
                <h2><i class="fa-icon-list"></i><span class="break"></span>Movimientos</h2>
                <div class="box-icon">
                        <a href="#" class="btn-minimize"><i class="icon-chevron-up"></i></a>
                </div>
        </div>
        <div class="box-content">
            <p>
        <div class="pull-right">
            Haber 
            <div class="input-prepend input-append" >
                <span class="add-on" style="color: blue">$</span>
                <input dir="rtl" style="color: blue" class="input-medium" type="text" autocomplete="off" onkeypress="return isNumberKey(this,event);" 
                       id="haberMov" readonly="readonly" value="{{empleado.cuenta.haber | number_format(2,'.', '')}}">
            </div>
            Debe 
            <div class="input-prepend input-append">
                <span class="add-on" style="color: orange">$</span>
                <input dir="rtl" style="color: orange" class="input-medium" type="text" autocomplete="off" onkeypress="return isNumberKey(this,event);" 
                       id="debeMov" readonly="readonly" value="{{empleado.cuenta.debe | number_format(2,'.', '')}}">
            </div>
            Saldo 
            <div class="input-prepend input-append">
                <span class="add-on" id="spanSal" {%if empleado.cuenta.saldo>=0%} style="color: green"  {%else%} style="color: red" {%endif%}>$</span>
                <input dir="rtl" {%if empleado.cuenta.saldo>=0%} style="color: green"  {%else%} style="color: red" {%endif%} class="input-medium" type="text" autocomplete="off" onkeypress="return isNumberKey(this,event);" 
                       id="saldoMov" readonly="readonly" value="{{empleado.cuenta.saldo | number_format(2,'.', '')}}">
            </div>
          </div> 
            <div><br><br></div>
            <div id="divTabla">
                {%if empleado.cuenta.movimientos | length > 0 %}
                <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered" id="example">
                    <thead class="header">
                        <th>#</th> 
                        <th>Fecha</th>
                        <th>Monto</th>
                        <th>Tipo</th>
                        <th>Descripcion</th>
                        <th>Fecha de emisión</th>
                    </thead>
                    {%set n =1%}
                {%for i in empleado.cuenta.movimientos %}
                    <tr>
                    <td>{{n}}</td>    
                    <td>{{i.fecha | date("d/m/Y")}}</td>
                    <td>{{i.monto | number_format(2,'.', '')}}</td>
                    <td>
                        {%if i.isContadoEmpleado%} Retiro en efectivo
                        {%elseif i.isCancelarEmpleado%}  Cancelación de pago
                        {%elseif i.isAdicionalEmpleado%}  Pago Adicional
                        {%elseif i.isSueldoEmpleado%}  Acreditación de sueldo
                        <button type="button" class="btn" rel="popover" data-placement="top" data-content="De: {{i.inicio | date("d/m/Y")}} | A: {{i.fin | date("d/m/Y")}}." onclick="$(this).popover();" data-original-title="Periodo"><i class="fa-icon-calendar"></i></button>
                         {%elseif i.isEspeciesEmpleado%}  Pago en especies
                         <button type="button" class="btn" title="Detalles" onclick="detallesModalEsp('{{i.id}}')"><i class="fa-icon-list-alt"></i></button>
                        
                        {%endif%}
                        {%if i.isIngresoEmpleado%}<span class="pull-right label label-info">Haber</span>
                        {%else%}<span class="pull-right label label-warning">Debe</span>
                        {%endif%}
                    </td>
                    <td>{{i.descripcion}}</td>
                    <td>{{i.fechaEmision | date("d/m/Y g:ia")}}</td>
                    </tr>
                    {%set n=n+1%}
                {%endfor%}
                </table>
                {%else%}
                <h3>No tiene movimientos registrados registrados</h3>
                {%endif%} 
                </div>
            </p>
            
        </div>
    </div><!--/span-->
</div>    
    <div class="row-fluid sortable ui-sortable">
<div class="box span6">
        <div class="box-header">
                <h2><i class="icon-th"></i><span class="break"></span>Datos principales</h2>
                <div class="box-icon">
                        <a href="#" class="btn-minimize"><i class="icon-chevron-down"></i></a>
                </div>
        </div>
        <div class="box-content" style="display: none;">
                    <p>
                    {{ form_row(form.dni) }}
                    {{ form_row(form.apellido) }}
                    {{ form_row(form.nombre) }}
                    {{ form_row(form.sexo) }}
                    {{ form_row(form.fechaNac) }}
                    {{ form_row(form.email) }} 
                    {{ form_row(form.fechaIngreso) }}
                            <div class="controls">
        <div class="accordion" id="accordion2">
            <div class="accordion-heading">
                <a class="accordion-toggle collapsed" title="Click para desplegar/replegar foto" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
                     Ver foto<i class="icon-circle-arrow-up"></i> 
                </a>
            </div>
            <div id="collapseOne" class="accordion-body collapse">
                 <div onmouseover="mostrarLinkFoto(this);" onmouseout="ocultarLinkFoto(this);" >
                    <button type="button" id="btnFoto" style="display: none" class="btn" onclick="verFoto();" title="Mostrar foto en patalla completa"><i class="fa-icon-external-link"></i></button>      
                   <a href="#" class="thumbnail span8"><img id="imagen" data-src="holder.js/180x160" {%if empleado.foto is defined and empleado.foto is not null%}   {%if empleado.foto.path!=null%} src="{{asset('uploads/imagenes/')}}{{empleado.foto.path}}" {%else%} {%if empleado.sexo%} src="{{asset('images/usuariom.jpg')}}" {%else%} src="{{asset('images/usuariof.jpg')}}"  {%endif%} {%endif%}{%else%} {%if empleado.sexo%} src="{{asset('images/usuariom.jpg')}}" {%else%} src="{{asset('images/usuariof.jpg')}}"  {%endif%}{%endif%} /></a> 
                </div>
            </div>
        </div>  
    </div>
                    </p>                  
</div>
</div><!--/span-->

<div class="box span6">
        <div class="box-header">
                <h2><i class="icon-th"></i><span class="break"></span>Dirección</h2>
                <div class="box-icon">
                        <a href="#" class="btn-minimize"><i class="icon-chevron-down"></i></a>
                </div>
        </div>
        <div class="box-content" style="display: none;">
<p>
    
    <div class="control-group">
        <label class="control-label">Provincia</label>
        <div class="controls">
            <input type="text" disabled="disabled" value="{{provincia}}">
        </div>
    </div>
<div class="control-group">
        <label class="control-label">Ciudad</label>
        <div class="controls">
                        {{ form_widget(form.direccion.ciudad) }}  
        </div>
    </div>  <p>   
                    {{ form_row(form.direccion.calle) }}
                    {{ form_row(form.direccion.numero) }}
                    {{ form_row(form.direccion.manzana) }}
                    {{ form_row(form.direccion.edificio) }}
                    {{ form_row(form.direccion.escalera) }}
                    {{ form_row(form.direccion.piso) }}
                    {{ form_row(form.direccion.departamento) }}
            
             {%if empleado.telefonos | length > 0 %}
                            <table class="table table-hover table-bordered table-condensed" data-spy="scroll">
                                <thead class="header">
                                <th>Nacional</th>
                                <th>Caracteristica</th>
                                <th>Número</th>
                                </thead>
                                {%for t in empleado.telefonos%}
                                <tr>
                                    <td>{{t.nacional}}</td>
                                    <td>{{t.caracteristica}}</td>
                                    <td>{{t.numero}}</td>
                                </tr>
                                {%endfor%}
                            </table>
                   {%else%}
                    <h3>No tiene telefonos registrados</h3>
                    {%endif%}   
</p>               
</div>
</div><!--/span-->
</div>      
<div class="row-fluid sortable ui-sortable">
<div class="box span6">
                <div class="box-header">
                        <h2><i class="icon-th"></i><span class="break"></span>Datos del cargo</h2>
                        <div class="box-icon">
                                <a href="#" class="btn-minimize"><i class="icon-chevron-down"></i></a>
                </div>
        </div>
        <div class="box-content" style="display: none;">
<p>                 {{ form_row(form.cargoAct.cargoSistema) }} 
                    {{ form_row(form.cargoAct.nombre) }} 
                    {{ form_row(form.cargoAct.descripcion) }} 
                    {{ form_row(form.cargoAct.tipo) }} 
                    {%if empleado.cargo.tipo==0 %}
                            {{ form_row(form.cargoAct.porFecha) }} 
                    {%elseif empleado.cargo.tipo==1%}
                        {{ form_row(form.cargoAct.porDia) }} 
                    {%elseif empleado.cargo.tipo==2%}
                            {{ form_row(form.cargoAct.porDiaSemana) }}  
                    {%endif%}
                    
                    {{ form_row(form.cargoAct.monto) }} 
                    {{ form_row(form.cargoAct.negativo) }} 
                    {{ form_row(form.cargoAct.descuento) }} 
                    {{ form_row(form.primerPago) }}                    
</p>
                </div>
        </div>
        <div class="box span6">
                <div class="box-header">
                        <h2><i class="icon-th"></i><span class="break"></span>Datos de usuario</h2>
                        <div class="box-icon">
                                <a href="#" class="btn-minimize"><i class="icon-chevron-down"></i></a>
                </div>
        </div>
        <div class="box-content" style="display: none;">
<p>
              <div class="control-group">
                           <label class="control-label">Nombre de Usuario</label>
                           <div class="controls">
                               <input type="text" id="username" name="[username]" disabled="disabled" readonly="readonly" maxlength="25" value="{{empleado.username}}">
                           </div>
                       </div>
                        <div class="control-group">
                           <label class="control-label">Rol</label>
                           <div class="controls">
                               <input type="text" id="rol" name="[rol]" disabled="disabled" readonly="readonly" maxlength="25" value="{{empleado.role}}">
                           </div>
                       </div>
                                            
</p>
                </div>
        </div><!--/span-->
</div>
<div class="row-fluid sortable ui-sortable">
    <div class="box span12">
        <div class="box-header">
                <h2><i class="fa-icon-list"></i><span class="break"></span>Historial de cargos</h2>
                <div class="box-icon">
                        <a href="#" class="btn-minimize"><i class="icon-chevron-up"></i></a>
                </div>
        </div>
        <div class="box-content">
            <p>
        
            <div id="divTablaCargos">
                {%if cargos | length > 0 %}
                <table class="table table-bordered table-hover">
                    <thead class="header">
                    <th>#</th> 
                    <th>Nombre</th>
                    <th>Descripcion</th>
                    <th>Monto</th>
                    <th>Tipo</th>
                    <th>Retiro sin haber</th>
                    <th style="text-align: center">Actual</th>
                    </thead>
                    {%set n =1%}
                {%for i in cargos %}
                    <tr>
                    <td>{{n}}</td>    
                    <td>{{i.nombre}}</td>
                    <td>{{i.descripcion}}</td>
                    <td>{{i.monto | number_format(2,'.', '')}}</td>
                    <td>{%if i.tipo==0%} Cada {{i.porFecha}} de cada mes{%elseif i.tipo==1%}Cada {{i.porDia}} días{%elseif i.tipo==2%}
                        {%if i.porDiaSemana==0%} Cada Domingo
                        {%elseif i.porDiaSemana==1%} Cada Lunes
                        {%elseif i.porDiaSemana==2%} Cada Martes
                        {%elseif i.porDiaSemana==3%} Cada Miércoles
                        {%elseif i.porDiaSemana==4%} Cada Jueves
                        {%elseif i.porDiaSemana==5%} Cada Viernes
                        {%elseif i.porDiaSemana==6%} Cada Sábado
                        {%endif%}
                    {%endif%}</td>
                    <td>{{i.negativo | number_format(2,'.', '')}}</td>
                    <td style="text-align: center">{%if i.activo%}<i class="fa-icon-ok"></i>{%else%}<i class="fa-icon-remove"></i>{%endif%}</td>
                    </tr>
                    {%set n=n+1%}
                {%endfor%}
                </table>
                {%else%}
                <h3>No tiene ningun cargo registrado</h3>
                {%endif%} 
                </div>
            </p>
            
        </div>
    </div><!--/span-->
</div>                 
            
        </form>
            </div>
        </div>
</div>
 {% endblock %}
{% block modal %}
<div id="pendientes" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Registrar generación de haberes</h3>
  </div>
  <div class="modal-body">
      <div id="pendientesDIV"></div>
  </div>
  
</div> 
 <div id="contado" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Registrar retiro de haber contado</h3>
  </div>
  <div class="modal-body">
      <div id="contadoDIV"></div>
  </div>
 
</div> 
<div id="adicional" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Registrar un pago adicional</h3>
  </div>
  <div class="modal-body">
      <div id="adicionalDIV"></div>
  </div>
  
</div> 
<div id="cancelar" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Registrar cancelación de pago</h3>
  </div>
  <div class="modal-body">
      <div id="cancelarDIV"></div>
  </div>
  
</div>
<div id="especies" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Registrar pago en especies</h3>
  </div>
        <div id="bodyEsp" class="modal-body">
      <div id="especiesDIV"></div>
  </div>
</div>
<div id="modalDescuento" class="modal hide fade" >
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Cambiar porcentaje de descuento</h3>
  </div>
        <div id="bodyDes" class="modal-body">
      <div id="descuentoDIV"></div>
  </div>
</div>
<div id="modalImprimir" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Imprimir datos del empleado</h3>
  </div>
  <div class="modal-body">
      Además de los datos del empleado imprimir:<br>
      <label class="checkbox">
          <input type="checkbox" id="chk1" value="">
          Resumen de saldo
    </label>
      <label class="checkbox">
          <input type="checkbox" id="chk2" value="">
          Movimientos
    </label>
        <label class="checkbox">
          <input type="checkbox" id="chk3" value="">
          Historial de cargos
    </label>
  </div>
  <div class="modal-footer">
      <a class="btn btn-primary" href="" target="_blank" onclick="impDetallesPerEmp('{{empleado.id}}', this);">Imprimir</a>  
    <button class="btn" data-dismiss="modal" aria-hidden="true">Cancelar</button>
  </div>      
</div>
<div id="verModalDetallesEsp" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" >
  <div class="modal-body">
      <div id="detallesModalEsp">
      </div>         
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Aceptar</button>
  </div>
</div>
{% endblock %}
{% block javascripts %}
    {{parent()}}
        <script type="text/javascript">
$(document).ready(function  (){ 
            $(document).keypress(function(e){
                if(e.which == 13){
                  return false;
                }
              });
         });
     function mostrarLinkFoto(ele){
        $('#btnFoto').removeAttr('style');
    }
     
    function ocultarLinkFoto(ele){
        $('#btnFoto').hide();
    }    
    
    function verFoto(ele){
        var img = document.getElementById('imagen');
        if (BigScreen.element !== img) {
                BigScreen.request(img);
        }
        else {
                BigScreen.exit();
        }
    }
   function cantidadPendientes(){
        $.getJSON("{{path ('cantidadPendientes')}}",{id:AID},function (json){
            var span=document.getElementById('notiCantidadPendientes');
            span.innerHTML =json;
            var val = parseFloat(json);
            val=0;
            if (val>0){
                $(span).removeClass('blue').addClass('yellow');
            }else{
                $(span).removeClass('yellow').addClass('blue');
            }
        });
   }
    function pendientes(id){
        AID=id;
        $('#pendientesDIV').load("{{ path('pendientes')}}",{'id':id},  function() {
            $('#pendientes').modal('toggle');
            $('#cuenta').val(id);
        }); 
    }
    var tipoPen=-1;
    function modalPendiente (tipo){
        tipoPen=tipo;
        $('#verModalPEN').modal('toggle');
    }

    function enviarPendientes(){
        $.post("{{path('registrarPagoEmpleado')}}",  { 'id': '{{empleado.id}}', 'tipo': tipoPen }  )
                .done(function(data) {
                  $('#pendientesFORM').remove();
                  $('#pendientesDIV').append(data);
                  $('#cuentaPEN').val('{{empleado.id}}');
                   actualizarMov();
                   pintarNum();
                   $('#verModalPEN').modal('toggle');
                   cantidadPendientes();
                });
            }

    function nuevoContado(id){
        AID=id;
        $('#contadoDIV').load("{{ path('nuevoContadoEmp')}}",{'id':id},  function() {
            if($('.datepicker')) {
                $('.datepicker').datepicker();
                $(".datepicker").datepicker($.datepicker.regional['es']);
            }
            $('#contado').modal('toggle');
            $('#cuenta').val(id);
          
        }); 
          $('#contadoFORM').submit(
                function(ev) {
                        ev.preventDefault();
                        altaContado();
                });
    }
    
    function cambiarMonto(ele){
        if ($.isNumeric(ele.value)){
            var num= parseFloat(ele.value);
            var haber = parseFloat($('#haber').attr('data-value'));
            var debe = parseFloat($('#debe').attr('data-value'));
            var saldo = parseFloat($('#saldo').attr('data-value'));
            var r = debe+num;
            if (r>haber){
                $("#saldo").css({ color: "#E60026"});
            }else{
                $("#saldo").css({ color: "#000000"});                
            }
            
            $('#debe').text((r).toFixed(2));
            $('#saldo').text((saldo-num).toFixed(2));
            
        }else{
            if (ele.value==''){
                var num= parseFloat('0');
                var haber = parseFloat($('#haber').attr('data-value'));
                var debe = parseFloat($('#debe').attr('data-value'));
                var saldo = parseFloat($('#saldo').attr('data-value'));
                var r = debe+num;
                if (r>haber){
                    $("#saldo").css({ color: "#E60026"});
                }else{
                    $("#saldo").css({ color: "#000000"});                
                }

                $('#debe').text((r).toFixed(2));
                $('#saldo').text((saldo-num).toFixed(2));
                
                }
                msjWC('Debe ingresar datos numéricos.');
           
        }
        
    }
    var AID = -1;
    function altaContado(){
        var val = parseFloat($('#sisgg_finalbundle_contadoempleadotype_monto').val());
        if (!($.isNumeric(val))||val<=0){
            msjWC("Debe ingresar un valor mayor a cero.");
            return false;
        }
        $.post("{{path('altaContadoEmp')}}",   $("#datos").serialize() )
            .done(function(data) {
              $('#contadoFORM').remove();
              $('#contadoDIV').append(data);
              $('#cuenta').val(AID);
               
               if ($('#especiesFORM').length){
               $('#contadoFORM').submit(
                function(ev) {
                        ev.preventDefault();
                        altaContado();
                });
            }else{
                actualizarMov();
               pintarNum();
            }
            });
        }
        
function nuevoAdicional(id){
        AID=id;
        $('#adicionalDIV').load("{{ path('nuevoAdicionalEmp')}}",{'id':id},  function() {
            if($('.datepicker')) {
                $('.datepicker').datepicker();
                $(".datepicker").datepicker($.datepicker.regional['es']);
            }
            $('#adicional').modal('toggle');
            $('#cuentaADIC').val(id);
            
        }); 
        $('#adicionalFORM').submit(
                function(ev) {
                        ev.preventDefault();
                        altaAdicional();
                });
    } 
 function cambiarMontoAdic(ele){
        if ($.isNumeric(ele.value)){
            var num= parseFloat(ele.value);
            var haber = parseFloat($('#haberADIC').attr('data-value'));
            var debe = parseFloat($('#debeADIC').attr('data-value'));
            var saldo = parseFloat($('#saldoADIC').attr('data-value'));
            var r = haber+num;
            if (r >= debe){
                $("#saldoADIC").css({ color: "#000000"});
            }else{
                $("#saldoADIC").css({ color: "#E60026"});

            }
            
            $('#haberADIC').text((r).toFixed(2));
            $('#saldoADIC').text((saldo+num).toFixed(2));
            
        }else{
            if (ele.value==''){
                var num= parseFloat('0');
                var haber = parseFloat($('#haberADIC').attr('data-value'));
                var debe = parseFloat($('#debeADIC').attr('data-value'));
                var saldo = parseFloat($('#saldoADIC').attr('data-value'));
                var r = haber+num;
                if (r>=debe){
                    $("#saldoADIC").css({ color: "#000000"});
                }else{
                    $("#saldoADIC").css({ color: "#E60026"});

                }

                $('#haberADIC').text((r).toFixed(2));
                $('#saldoADIC').text((saldo+num).toFixed(2));
                
                }
                msjWC('Debe ingresar datos numéricos.');
           
        }
        
    }   
   function altaAdicional(){
        var val = parseFloat($('#sisgg_finalbundle_adicionalempleadotype_monto').val());
        if (!($.isNumeric(val))||val<=0){
            msjWC("Debe ingresar un valor mayor a cero.");
            return false;
        }
        $.post("{{path('altaAdicionalEmp')}}", $("#datosADIC").serialize() )
            .done(function(data) {
              $('#adicionalFORM').remove();
              $('#adicionalDIV').append(data);
              $('#cuentaADIC').val(AID);
              if ($('#cancelarFORM').length){
              $('#adicionalFORM').submit(
                function(ev) {
                        ev.preventDefault();
                        altaAdicional();
                });
            }else{
               actualizarMov();
               pintarNum();
            }  
            });
        }  
 

    function nuevoCancelar(id){
        AID=id;
        $('#cancelarDIV').load("{{ path('nuevoCancelarEmp')}}",{'id':id},  function() {
            if($('.datepicker')) {
                $('.datepicker').datepicker();
                $(".datepicker").datepicker($.datepicker.regional['es']);
            }
            $('#cancelar').modal('toggle');
            $('#cuentaCANC').val(id);
        }); 
        $('#cancelarFORM').submit(
                function(ev) {
                        ev.preventDefault();
                        altaCancelar();
                });
    }
    
    function cambiarMontoCanc(ele){
        if ($.isNumeric(ele.value)){
            var num= parseFloat(ele.value);
            var haber = parseFloat($('#haberCANC').attr('data-value'));
            var debe = parseFloat($('#debeCANC').attr('data-value'));
            var saldo = parseFloat($('#saldoCANC').attr('data-value'));
            var r = debe+num;
            if (r>haber){
                $("#saldoCANC").css({ color: "#E60026"});
            }else{
                $("#saldoCANC").css({ color: "#000000"});                
            }
            
            $('#debeCANC').text((r).toFixed(2));
            $('#saldoCANC').text((saldo-num).toFixed(2));
            
        }else{
            if (ele.value==''){
                var num= parseFloat('0');
                var haber = parseFloat($('#haberCANC').attr('data-value'));
                var debe = parseFloat($('#debeCANC').attr('data-value'));
                var saldo = parseFloat($('#saldoCANC').attr('data-value'));
                var r = debe+num;
                if (r>haber){
                    $("#saldoCANC").css({ color: "#E60026"});
                }else{
                    $("#saldoCANC").css({ color: "#000000"});                
                }

                $('#debeCANC').text((r).toFixed(2));
                $('#saldoCANC').text((saldo-num).toFixed(2));
                
                }
                msjWC('Debe ingresar datos numéricos.');
           
        }
        
    }
    function altaCancelar(){
        var val = parseFloat($('#sisgg_finalbundle_cancelarempleadotype_monto').val());
        if (!($.isNumeric(val))||val<=0){
            msjWC("Debe ingresar un valor mayor a cero.");
            return false;
        }
        $.post("{{path('altaCancelarEmp')}}",   $("#datosCANC").serialize() )
            .done(function(data) {
              $('#cancelarFORM').remove();
              $('#cancelarDIV').append(data);
              $('#cuentaCANC').val(AID);
              if ($('#cancelarFORM').length){
                $('#cancelarFORM').submit(
                  function(ev) {
                          ev.preventDefault();
                          altaCancelar();
                  });
            }else{
               actualizarMov();
               pintarNum();
           }
            });
        }

function nuevoDescuento(){
        
        $('#descuentoDIV').load("{{ path('cambiarDescuento')}}",{'idEmpleado':AID},  function() {
            
            $('#modalDescuento').modal('toggle');
            $('#idEmpleado').val(AID);
        }); 
        $('#formDescuento').submit(
                function(ev) {
                        ev.preventDefault();
                        altaDescuento();
                });
    }

function altaDescuento(){
        var val = parseFloat($('#txtDescuento').val());
        if (!($.isNumeric(val))||(val<0||val>100)){
            msjWC("Debe ingresar un valor entre 0 y 100.");
            return false;
        }
        $.post("{{path('cambiarDescuento')}}",   $("#datosDescuento").serialize() )
            .done(function(data) {
              $('#formDescuento').remove();
              $('#descuentoDIV').append(data);
              $('#idEmpleado').val(AID);
              if ($('#formDescuento').length){
                $('#formDescuento').submit(
                  function(ev) {
                          ev.preventDefault();
                          altaDescuento();
                  });
            }else{
                var table = document.getElementById('itemsNP');
                var rows = table.getElementsByTagName('tr');
                if(rows.length==2){
                    var total = parseFloat('0.00');
                }else{
                    var total = parseFloat($('#montoEspecies').val());
                }
                var desc = parseFloat($('#hiddenDescuento').val());
                $('#descEspeciesPorc').val(desc.toFixed());
                var descPesos = (total*desc)/100;
                $('#descEspeciesPesos').val(descPesos.toFixed(2));
                $('#totalEspecies').val((total-descPesos).toFixed(2));
           }
            });
        }
        
function nuevoEspecies(id){
        AID=id;
        $('#especiesDIV').load("{{ path('nuevoEspeciesEmp')}}",{'id':id},  function() {
            if($('.datepicker')) {
                $('.datepicker').datepicker();
                $(".datepicker").datepicker($.datepicker.regional['es']);
            }
            $('#especies').modal('toggle');
            $('#sisgg_finalbundle_especiesempleadotype_monto').val('0.00');
            $('#cuentaESP').val(id);
            $('#musharo').dataTable( {
		"sDom": "<'row'<'span6'l><'span6'f>r>t<'row'<'span6'i><'span6'p>>",
		"sPaginationType": "bootstrap",
                "aLengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
		"oLanguage": {
			"sLengthMenu": "_MENU_ Registros por página",
                        "sSearch": "Buscar:",
                    "sInfo": " Mostrado _START_ a _END_ de _TOTAL_ registros",
                        "sInfoEmpty": "Mostrado 0 a 0 de 0 registros",
                        "sInfoFiltered": "(filtrado de _MAX_ registros totales)",
                        "sZeroRecords": "Ningun registro encontrado",
                        "oPaginate": {
				             "sPrevious": "Anterior",
                                             "sNext": "Siguiente"
				     }
		}
	} );
        }); 
        $('#especiesFORM').submit(
                function(ev) {
                        ev.preventDefault();
                        altaEspecies();
        });
    }
    function altaEspecies(){
        var table = document.getElementById('itemsNP');
        var rows = table.getElementsByTagName('tr');
        if(rows.length==1){
            msjWC('Debe agragar al menos un producto.');
            return false;
        }
        $.post("{{path('altaEspeciesEmp')}}",   $("#datosESP").serialize() )
            .done(function(data) {
              $('#especiesFORM').remove();
              $('#especiesDIV').append(data);
              $('#cuentaESP').val(AID);
              if ($('#especiesFORM').length){
                  $('#especiesFORM').submit(function(ev) {
                        ev.preventDefault();
                        altaEspecies();
                    });
                    sumarTotal();
              }else{
               actualizarMov();
               pintarNum();}
            });
        }
        
    function detallesModalEsp(id){
        var url = "{{path('detallesEspeciesEmp')}}";
        $('#detallesModalEsp').load(url,{'id':id});
        $('#verModalDetallesEsp').modal('toggle');
    }
    function cambiarMontoEsp(ele){
        if ($.isNumeric(ele.value)){
            var num= parseFloat(ele.value);
            var haber = parseFloat($('#haberESP').attr('data-value'));
            var debe = parseFloat($('#debeESP').attr('data-value'));
            var saldo = parseFloat($('#saldoESP').attr('data-value'));
            var r = debe+num;
            if (r>haber){
                $("#saldoESP").css({ color: "#E60026"});
            }else{
                $("#saldoESP").css({ color: "#000000"});                
            }
            
            $('#debeESP').text((r).toFixed(2));
            $('#saldoESP').text((saldo-num).toFixed(2));
            
        }else{
            if (ele.value==''){
                var num= parseFloat('0');
                var haber = parseFloat($('#haberESP').attr('data-value'));
                var debe = parseFloat($('#debeESP').attr('data-value'));
                var saldo = parseFloat($('#saldoESP').attr('data-value'));
                var r = debe+num;
                if (r>haber){
                    $("#saldoESP").css({ color: "#E60026"});
                }else{
                    $("#saldoESP").css({ color: "#000000"});                
                }

                $('#debeESP').text((r).toFixed(2));
                $('#saldoESP').text((saldo-num).toFixed(2));
                
                }
                msjWC('Debe ingresar datos numéricos.');
           
        }
        
    }
            

var AID = {{empleado.id}};

function lostFoc(ele){
    if (ele.value=='')
        ele.value='0';
} 

function cerrarEspecies(ele, modal){
    $('#'+modal).modal('toggle');
}

 function actualizarMov(){
        
            var div = document.getElementById('divTabla');
            $(div.firstElementChild).remove();
            var img = document.createElement('img');
            img.src='{{asset('images/loading.gif')}}';      
            $(div).append(img);
            $(div).load('{{path('actTablaMovEmp')}}',{'id':'{{empleado.id}}'}, function (){
                cargarTabla();
            });
    
    }
    function cargarTabla(){
        $('#example').dataTable( {
		"sDom": "<'row'<'span6'l><'span6'f>r>t<'row'<'span6'i><'span6'p>>",
		"sPaginationType": "bootstrap",
                "aLengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
		"oLanguage": {
			"sLengthMenu": "_MENU_ Registros por página",
                        "sSearch": "Buscar:",
                    "sInfo": " Mostrado _START_ a _END_ de _TOTAL_ registros",
                        "sInfoEmpty": "Mostrado 0 a 0 de 0 registros",
                        "sInfoFiltered": "(filtrado de _MAX_ registros totales)",
                        "sZeroRecords": "Ningun registro encontrado",
                        "oPaginate": {
				             "sPrevious": "Anterior",
                                             "sNext": "Siguiente"
				     }
		}
	} );
        $('[rel="popover"],[data-rel="popover"]').popover();
        //txt();
    }
    function txt(){
       $("#txtBuscarTabla").keyup (function() {
            var table = document.getElementById('example');
            var rows = table.getElementsByTagName('tr');
            var total = parseFloat('0.00');
            for (var i = 1; i <rows.length; ++i) {          
                var num =$(rows[i].cells[5]).text(); 
                if (!($.isNumeric(num))){
                    num = parseFloat('0.00');;
                }else{
                    num = parseFloat(num);             
                }
                total=num+total;
            }
            if ($.isNumeric(total))
            $('#totalCompras').val(total.toFixed(2)); 

               });
   }
   
   function pintarNum(){
      $('#saldoMov').val($('#saldoTab').val());
      $('#debeMov').val($('#debeTab').val());
      $('#haberMov').val($('#haberTab').val());
      $('#saldoMov').css( {color: $('#colorTab').val()});
      $('#spanSal').css( {color: $('#colorTab').val()});
   }
   
   
   //pago en especies
   
   
var clase='sisgg_finalbundle_especiesempleadotype_item_';
var elemento='sisgg_finalbundle_notapedidotype_';
var fila='';

    function cambioProducto(ele){
        var id=ele.options[ele.options.selectedIndex].value;
        fila = ele.parentNode.parentNode.parentNode.id.replace(clase, '');
        $.getJSON("{{path ('obtenerProducto')}}",{id:id},function (json){
        //alert(json.tasa);
        seleccionarTasa(json.tasa, fila);
        $('#'+clase+fila+'_precioCosto').val(json.precioVenta);
        $('#'+clase+fila+'_cantidad').val(1); 
         $('#'+clase+fila+'_total').val(0.00); 
         var ele = document.getElementById(clase+fila+'_precioCosto');
         cambiarCosto(ele);
         sumarTotal();
        });
    }
    function seleccionarProducto(id){
        
        $.getJSON("{{path ('obtenerProducto')}}",{id:id},function (json){
        //alert(json.tasa);
        seleccionarTasa(json.tasa, fila);
        $('#'+clase+fila+'_precioCosto').val(json.precioVenta);
        $('#'+clase+fila+'_cantidad').val(1); 
         $('#'+clase+fila+'_total').val(0.00);
         comboProducto(id);
         var ele = document.getElementById(clase+fila+'_precioCosto');
         cambiarCosto(ele);
         sumarTotal();
            $('#verTabla').modal('hide');
        });
    }

    function buscarEnCombo(ele){
        fila = ele.parentNode.parentNode.parentNode.id.replace(clase, '');
            $('#verTabla').modal('toggle');
    }
    
    function comboProducto(id){
        
        var combo =document.getElementById(clase+fila+'_producto');
        for (var i=0;i<combo.length;i++){
            if (combo.options[i].value==id){
                combo.options[i].selected="selected";  
            }
        }
        
    }
    
    function cambiarCantidad(ele){
        fila = ele.parentNode.parentNode.id.replace(clase, '');
        var costo=$('#'+clase+fila+'_precioCosto').val();
        //alert(costo);
        var cant=$(ele).val();
        //alert(costo+cant);
        if (($.isNumeric(costo))&&($.isNumeric(cant))){
            $('#'+clase+fila+'_total').val((cant*costo).toFixed(2));       
        }else{
            $('#'+clase+fila+'_total').val(0.00);  
        }
        sumarTotal();
      }
      
    function cambiarCosto(ele){
     fila = ele.parentNode.parentNode.id.replace(clase, '');
    var cant=$('#'+clase+fila+'_cantidad').val();
    //alert(costo);
    var costo=$(ele).val();
    //alert(costo+cant);
    if (($.isNumeric(costo))&&($.isNumeric(cant))){
        $('#'+clase+fila+'_total').val((cant*costo).toFixed(2));       
    }else{
        $('#'+clase+fila+'_total').val(0.00);  
    }
    sumarTotal();
      }
      
    function sumarTotal(){
        var table = document.getElementById('itemsNP');
        var rows = table.getElementsByTagName('tr');
        var total = parseFloat('0.00');
        
        for (var i = 1; i <rows.length -1; ++i) {          
            var num = parseFloat(rows[i].cells[4].firstChild.value); 
            total=num+total;
        }
        if ($.isNumeric(total)){
            $('#montoEspecies').val(total.toFixed(2));
            var desc = parseFloat($('#descEspeciesPorc').val());
            var descPesos = (total*desc)/100;
            $('#descEspeciesPesos').val(descPesos.toFixed(2));
            $('#totalEspecies').val((total-descPesos).toFixed(2));
        }
        var ele = document.getElementById('totalEspecies');
        cambiarMontoEsp(ele);
    }
    
    
    function seleccionarTasa(tasa, fila){
        
        //var comboTasa=document.getElementById(clase+fila+'_tasa');
        //alert(comboTasa);
        $('#'+clase+fila+'_tasa').load("{{ path('seleccionarTasa')}}",{'name':tasa}, function() {             
            });
    }
    
    
    function cargarProducto( ){
            $('#'+clase+fila+'_producto').load("{{ path('cargarMerPla')}}", function() {
                
            });
            seleccionarProducto($('#'+clase+fila+'_producto').val());
             var ele = document.getElementById(clase+fila+'_precioCosto');
             cambiarCosto(ele);
             sumarTotal();
    }
    
    
 function nuevaFila(e,id) {
    e.preventDefault();
    var desc = parseFloat($('#negativo').attr('data-value'));
    var saldo = parseFloat($('#saldoESP').html());
    if ((desc+saldo)<0){
        msjWC("El los gatos superan el saldo disponible");
        return false;
    }
    // Get the data-prototype explained earlier
    var collectionHolder = $("#"+id);
    
    var prototype = collectionHolder.data('prototype');
    // get the new index
    var index = collectionHolder.data('index');
    // Replace '$$name$$' in the prototype's HTML to
    // instead be a number based on how many items we have
    var newForm = prototype.replace(/__name__/g, index);
    // increase the index with one for the next item
    collectionHolder.data('index', index + 1);
    // Display the form in the page in an li, before the "Add a tag" link li
    var $newFormLi = collectionHolder.append(newForm);
    $('[data-rel="chosen"],[rel="chosen"]').chosen();
    //inicializarFila(index);
    //alert(index);
    fila=index;
    cargarProducto();
} 

function eliminarFila(e,id){
    e.preventDefault();
    $('#'+id).remove();
     sumarTotal();
}

//Imprimir

function imprimirRetiro(id,tipo, ele){
    var url = "{{path('impEgresoEmpleado', {'tipo':'elloco' ,'id': '__id__' , '_format':'pdf'})}}".replace(/__id__/g,id);
    url= url.replace('amp;', '');
    url= url.replace('amp;', '');
    url=url.replace('elloco', tipo);
    $(ele).attr('href',url);
}

function impDetallesPerEmp(id, ele){
    var url = "{{path('impDetallesPerEmp', {'chk1':'imp1','chk2':'imp2','chk3':'imp3','id': '__id__' , '_format':'pdf'})}}".replace(/__id__/g,id);
    url= url.replace('amp;', '');
    url= url.replace('amp;', '');
    url= url.replace('amp;', '');
    url= url.replace('amp;', '');
    if (document.getElementById('chk1').checked==true){
        url= url.replace('imp1', 1);
    }else{
        url= url.replace('imp1', 0);
    }
    if (document.getElementById('chk2').checked==true){
        url= url.replace('imp2', 1);
    }else{
        url= url.replace('imp2', 0);
    }
    if (document.getElementById('chk3').checked==true){
        url= url.replace('imp3', 1);
    }else{
        url= url.replace('imp3', 0);
    }
    $(ele).attr('href',url);
}

function modalImprimir(){
    $('#modalImprimir').modal('toggle');
}
            </script>
{% endblock%}
{% block css %}
    {{parent()}}

<style type="text/css">
#especies.modal.fade.in {
    top: 3%;
}
#especies.modal   {
    width: 880px;
    left: 38%;
    height:  575px;
    right: 260px; /* PLAY THE WITH THE VALUES TO SEE GET THE DESIRED EFFECT */
}
#bodyEsp.modal-body   {
    position: relative;
    max-height: 485px;
    padding: 15px;
    overflow-y: auto;
    width: 850px;
    
}
#pendientes.modal.fade.in {
top: 3%;
}
#pendientes.modal   {
    width: 830px;
    left: 40%;
    right: 260px; /* PLAY THE WITH THE VALUES TO SEE GET THE DESIRED EFFECT */
}
#pendientes.modal-body   {
    max-height:  475px;
    width: 800px;
    
}


.modal-body   {
    max-height:  475px;
    
    
}

 </style>
{% endblock%}